name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üîç Check PR title
      uses: amannn/action-semantic-pull-request@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
        requireScope: false

    - name: üìè Check PR size
      run: |
        FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')
        
        echo "Files changed: $FILES_CHANGED"
        echo "Lines changed: $LINES_CHANGED"
        
        if [ "$FILES_CHANGED" -gt 50 ]; then
          echo "‚ö†Ô∏è Warning: This PR changes more than 50 files. Consider breaking it into smaller PRs."
        fi
        
        if [ "$LINES_CHANGED" -gt 1000 ]; then
          echo "‚ö†Ô∏è Warning: This PR changes more than 1000 lines. Consider breaking it into smaller PRs."
        fi

    - name: üîç Check for conflicts
      run: |
        git fetch origin ${{ github.base_ref }}
        if git merge-base --is-ancestor HEAD origin/${{ github.base_ref }}; then
          echo "‚úÖ No conflicts detected"
        else
          echo "‚ö†Ô∏è This branch might have conflicts with base branch"
        fi

  conventional-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üîç Check commit messages
      run: |
        echo "Checking commit messages..."
        COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s")
        
        while IFS= read -r commit; do
          if [[ ! "$commit" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: ]]; then
            echo "‚ùå Invalid commit message: $commit"
            echo "Commit messages should follow Conventional Commits format"
            exit 1
          fi
        done <<< "$COMMITS"
        
        echo "‚úÖ All commit messages are valid"

  label-check:
    name: Ensure PR has labels
    runs-on: ubuntu-latest
    
    steps:
    - name: üè∑Ô∏è Check labels
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          if (pullRequest.labels.length === 0) {
            core.setFailed('‚ùå Please add at least one label to this PR');
          } else {
            console.log('‚úÖ PR has labels:', pullRequest.labels.map(l => l.name).join(', '));
          }
